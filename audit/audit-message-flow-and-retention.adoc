---
permalink: audit/audit-message-flow-and-retention.html 
sidebar: sidebar 
keywords: storagegrid, audit, message, flow, retention 
summary: Tutti i servizi StorageGRID generano messaggi di audit durante il normale funzionamento del sistema. È necessario comprendere come questi messaggi di audit si spostano nel sistema StorageGRID al file audit.log. 
---
= Controllare il flusso e la conservazione dei messaggi
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
Tutti i servizi StorageGRID generano messaggi di audit durante il normale funzionamento del sistema. È necessario comprendere in che modo questi messaggi di controllo passano dal sistema StorageGRID al `audit.log` file.

I seguenti flussi di lavoro per i messaggi di controllo e la conservazione dei messaggi di controllo sono applicabili solo se StorageGRID è configurato per *Nodi amministrativi/nodi locali* o *Nodo amministrativo e server syslog esterno*.  Se StorageGRID è configurato per "Solo nodi locali" (predefinito) o "Server syslog esterno", i messaggi di controllo vengono salvati localmente su ciascun nodo nel `/var/local/log/localaudit.log` file e non può essere elaborato dai nodi di amministrazione o dai nodi di archiviazione.



== Controllare il flusso dei messaggi

I messaggi di controllo vengono elaborati dai nodi amministrativi quando StorageGRID è configurato per *nodi amministrativi/nodi locali* o *nodo amministrativo e server syslog esterno* e dai nodi di archiviazione che dispongono di un servizio di controller di dominio amministrativo (ADC).

Come mostrato nel diagramma di flusso dei messaggi di audit, ciascun nodo StorageGRID invia i propri messaggi di audit a uno dei servizi ADC nel sito del data center. Il servizio ADC viene attivato automaticamente per i primi tre nodi di storage installati in ogni sito.

A sua volta, ogni servizio ADC agisce come un relay e invia la propria raccolta di messaggi di audit a ogni nodo amministrativo nel sistema StorageGRID, che fornisce a ciascun nodo amministrativo un record completo dell'attività del sistema.

Ogni nodo amministrativo memorizza i messaggi di controllo in file di registro di testo; il file di registro attivo è denominato `audit.log`.

image::../media/audit_message_flow.gif[Diagramma che riepiloga il flusso dei messaggi di audit attraverso i relay]



=== Controllare la conservazione dei messaggi

StorageGRID utilizza un processo di copia e cancellazione per garantire che non vengano persi messaggi di controllo prima di poter essere scritti nel registro di controllo.

Quando un nodo genera o inoltra un messaggio di controllo, il messaggio viene memorizzato in una coda di messaggi di controllo sul disco di sistema del nodo della griglia.  Una copia del messaggio viene sempre conservata in una coda di messaggi di controllo finché il messaggio non viene scritto nel file di registro di controllo nel nodo di amministrazione `/var/local/audit/export` elenco.  Ciò aiuta a prevenire la perdita di un messaggio di controllo durante il trasporto.

image::../media/audit_message_retention.gif[Diagramma che riassume la ricezione del messaggio di audit presso l'AMS]

La coda dei messaggi di controllo può aumentare temporaneamente a causa di problemi di connettività di rete o di capacità di controllo insufficiente.  Man mano che le code aumentano, consumano più spazio disponibile in ciascun nodo `/var/local/` elenco.  Se il problema persiste e la directory dei messaggi di controllo di un nodo diventa troppo piena, i singoli nodi danno priorità all'elaborazione del loro arretrato e diventano temporaneamente non disponibili per nuovi messaggi.

In particolare, potrebbero verificarsi i seguenti comportamenti:

* Se il `/var/local/audit/export` Quando la directory utilizzata da un nodo di amministrazione diventa piena, il nodo di amministrazione viene contrassegnato come non disponibile per nuovi messaggi di controllo finché la directory non è più piena.  Le richieste del client S3 non sono interessate.  L'allarme XAMS (Unreachable Audit Repositories) viene attivato quando un repository di audit non è raggiungibile.
* Se il `/var/local/` Quando la directory utilizzata da un nodo di archiviazione con il servizio ADC è piena al 92%, il nodo viene contrassegnato come non disponibile per i messaggi di controllo finché la directory non è piena solo all'87%.  Le richieste del client S3 ad altri nodi non sono interessate.  L'allarme NRLY (Available Audit Relays) viene attivato quando i relay di audit non sono raggiungibili.
+

NOTE: Se non vi sono nodi di archiviazione disponibili con il servizio ADC, i nodi di archiviazione memorizzano i messaggi di controllo localmente nel `/var/local/log/localaudit.log` file.

* Se il `/var/local/` directory utilizzata da un nodo di archiviazione diventa piena all'85%, il nodo inizia a rifiutare le richieste del client S3 con `503 Service Unavailable` .


I seguenti tipi di problemi possono causare un aumento delle code dei messaggi di audit:

* Interruzione di un nodo amministrativo o di un nodo di storage con il servizio ADC. Se uno dei nodi del sistema non è attivo, i nodi rimanenti potrebbero diventare backlogged.
* Tasso di attività sostenuta che supera la capacità di audit del sistema.
* Lo `/var/local/` spazio su un nodo di archiviazione ADC si riempie per motivi non correlati ai messaggi di controllo. In questo caso, il nodo smette di accettare nuovi messaggi di audit e assegna la priorità al backlog corrente, che può causare backlog su altri nodi.




=== Avviso di coda di audit estesa e allarme di messaggi di audit in coda (AMQS)

Per facilitare il monitoraggio delle dimensioni delle code dei messaggi di controllo nel tempo, l'avviso *Large audit queue* e l'allarme AMQS legacy vengono attivati quando il numero di messaggi in una coda Storage Node o Admin Node raggiunge determinate soglie.

Se viene attivato l'avviso *Large audit queue* o l'allarme AMQS legacy, iniziare controllando il carico sul sistema. Se si è verificato un numero significativo di transazioni recenti, l'avviso e l'allarme devono essere risolti nel tempo e possono essere ignorati.

Se l'avviso o l'allarme persiste e aumenta di gravità, visualizza un grafico delle dimensioni della coda.  Se il numero aumenta costantemente nel corso di ore o giorni, è probabile che il carico di controllo abbia superato la capacità di controllo del sistema.  Ridurre la frequenza operativa del client o diminuire il numero di messaggi di controllo registrati modificando il livello di controllo per Scritture client e Letture client su Errore o Disattivato. Vedere link:../monitor/configure-log-management.html["Configurare la gestione dei log e il server syslog esterno"] .



=== Messaggi duplicati

Il sistema StorageGRID adotta un approccio conservativo in caso di guasto di rete o nodo. Per questo motivo, nel registro di controllo potrebbero essere presenti messaggi duplicati.
